<Module 
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="../FrankConfig.xsd">

	<Adapter name="BrpPersonenNotificationProcessor"
		description="brp personen notification processor">
		<Receiver name="BrpPersonenNotificationProcessorDailyTaskListener">
			<JdbcTableListener tableName="tasks_daily" statusField="status" statusValueError="E" statusValueProcessed="C" keyField="task_id" messageField="bsn" />
		</Receiver>

		<Receiver name="BrpPersonenNotificationProcessorHourlyTaskListener">
			<JdbcTableListener tableName="tasks_hourly" statusField="status" statusValueError="E" statusValueProcessed="C" keyField="task_id" messageField="bsn" />
		</Receiver>

		<Pipeline>
			<Exits>
				<Exit name="EXIT" state="SUCCESS" />
			</Exits>

            <PutInSessionPipe name="ExtractIncomingNotificationData">
                <Param name="bsn" sessionKey="originalMessage" />
                <Forward name="success" path="processNotifications"/>
            </PutInSessionPipe>

			<SenderPipe name="processNotifications">
                <IbisLocalSender
                    name="personenUpdater"
                    javaListener="BrpPersonenUpdateAndNotify">
					<Param name="burgerservicenummer" sessionKey="bsn" />
                </IbisLocalSender>
			</SenderPipe>

			<XmlIfPipe name="CheckUpdateSuccess" expressionValue="true">
				<Forward name="then" path="echoPipe" />
				<Forward name="else" path="RetryNotification" />
			</XmlIfPipe>

			<SenderPipe name="SetTaskToRetry">
				<FixedQuerySender query="SetTaskToRetry">

				</FixedQuerySender>
			</SenderPipe>

			<EchoPipe name="RetryNotification">
				<Forward name="success" path="EXIT" />
			</EchoPipe>

			<EchoPipe name="echoPipe">
				<Forward name="success" path="EXIT" />
			</EchoPipe>
		</Pipeline>
	</Adapter>
</Module>