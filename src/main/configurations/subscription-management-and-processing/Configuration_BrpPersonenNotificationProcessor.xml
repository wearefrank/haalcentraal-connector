<Module 
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="../FrankConfig.xsd">

	<Adapter name="BrpPersonenNotificationProcessor"
		description="brp personen notification processor">
		<Receiver name="BrpPersonenNotificationProcessorDailyTaskListener">
			<JdbcTableListener tableName="tasks" statusField="status" statusValueError="E" statusValueProcessed="C" keyField="task_id" messageField="bsn" selectCondition="scheduled_start &lt;= NOW()"/>
		</Receiver>

		<Pipeline>
			<Exits>
				<Exit name="EXIT" state="SUCCESS" />
				<Exit name="EXCEPTION" state="ERROR" />
				<Exit name="NoSubscribersToPerson" state="SUCCESS" />
			</Exits>

            <PutInSessionPipe name="ExtractIncomingNotificationData">
                <Param name="bsn" sessionKey="originalMessage" />
                <Forward name="success" path="processNotifications"/>
            </PutInSessionPipe>

			<!-- Check if subscribers are found for the task bsn -->
            <SenderPipe name="GetSubscribers">
                <FixedQuerySender
					name="getPersonenSender"
                    queryType="SELECT"
					query="SELECT 1 FROM subscripties WHERE bsn=?{bsn} AND eind_datum IS NULL"
					includeFieldDefinition="false">
					<Param name="bsn" sessionKey="bsn"/>
            	</FixedQuerySender> 
                <Forward name="success" path="CheckSubscriptionCount" />
                <Forward name="exception" path="EXCEPTION" />
            </SenderPipe>

            <!-- Check if subscriptions are found -->
            <XmlIfPipe
                name="CheckSubscriptionCount"
                xpathExpression="count(result/rowset/row) > 0"
            >
				<!-- Process the task if subscribers are found, else exit -->
                <Forward name="then" path="processNotifications"/>
                <Forward name="else" path="NoSubscribersToPerson"/>
            </XmlIfPipe>

			<!-- TODO: Skip sync, or update bsn for ACC -->

			<SenderPipe name="processNotifications">
                <IbisLocalSender
                    name="personenUpdater"
                    javaListener="BrpPersonenUpdateAndNotify">
					<Param name="burgerservicenummer" sessionKey="bsn" />
                </IbisLocalSender>
			</SenderPipe>

			<XmlIfPipe name="CheckUpdateSuccess" expressionValue="true">
				<Forward name="then" path="EXIT" />
				<Forward name="else" path="GetCurrentTask" />
			</XmlIfPipe>

			<SenderPipe name="GetCurrentTask" >
				<FixedQuerySender queryType="SELECT" name="getCurrentTask" query="SELECT * FROM tasks WHERE task_id = ?">
					<Param name="task_id" sessionKey="key" />
				</FixedQuerySender>
				<Forward name="success" path="CheckAttemptCount" />
			</SenderPipe>

			<XmlIfPipe name="CheckAttemptCount" xpathExpression="/result/rowset/row/field[@name='ATTEMPT'] > 3">
				<Forward name="then" path="EXCEPTION" />
				<Forward name="else" path="RetryNotification" />
			</XmlIfPipe>

			<!-- Add a new task to retry synchronization -->
            <SenderPipe name="RetryNotification">
                <FixedQuerySender
					name="CreateRetryTask"
                    queryType="OTHER"
					query="WITH last_attempt AS (
								SELECT correlation_id, attempt, scheduled_start
								FROM tasks
								WHERE task_id = ?{task_id}
							)
							INSERT INTO tasks (correlation_id, created_at, scheduled_start, status, attempt, bsn)
							SELECT
								correlation_id,
								CURRENT_TIMESTAMP,
								CASE
									WHEN EXTRACT(DOW FROM scheduled_start + INTERVAL '24 hours') = 6 THEN scheduled_start + INTERVAL '3 days'
									WHEN EXTRACT(DOW FROM scheduled_start + INTERVAL '24 hours') = 0 THEN scheduled_start + INTERVAL '2 days'
									ELSE scheduled_start + INTERVAL '24 hours'
								END AS scheduled_start,
								'P',
								attempt + 1,
								?{bsn}
							FROM last_attempt;">
					<Param name="task_id" sessionKey="mid" type="INTEGER" />
					<Param name="bsn" sessionKey="bsn" type="STRING" />
            	</FixedQuerySender> 
                <Forward name="success" path="EXIT" />
            </SenderPipe>
		</Pipeline>
	</Adapter>
</Module>