<Module 
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="../FrankConfig.xsd">
	<Adapter name="BRP Personen query sender"
		description="query sender voor brp personen">

		<Receiver name="BRP Personen query sender">
			<JavaListener name="BRP Personen query sender" />
		</Receiver>

		<Pipeline>
			<Exits>
				<Exit name="EXIT" state="SUCCESS" />
				<Exit name="BadRequest" state="ERROR" code="400" empty="true" />
				<Exit name="NotAuthorized" state="ERROR" code="401" empty="true" />
				<Exit name="Forbidden" state="ERROR" code="403" empty="true" />
				<Exit name="NotFound" state="ERROR" code="404" empty="true" />
				<Exit name="NotAcceptable" state="ERROR" code="406" empty="true" />
				<Exit name="UnsupportedMediaType" state="ERROR" code="415" empty="true" />
				<Exit name="TooManyRequest" state="ERROR" code="429" empty="true" />
				<Exit name="ServerError" state="ERROR" code="500" />
				<Exit name="ServiceUnavailable" state="ERROR" code="503" />
			</Exits>

            <SenderPipe 
                name="GetApplicationConfigFromLocalFS"
                storeResultInSessionKey="ApplicationConfig"
                >
                <IbisLocalSender
                    name="CallImportFromLocalFS"
                    javaListener="ImportFromLocalFS"
                    returnedSessionKeys="Error">
                    <Param name="FileName" value="${FilePath_1}" />
                </IbisLocalSender>
                <Forward name="success" path="filter"/>
                <Forward name="exception" path="BadRequest" />
            </SenderPipe>

            <XsltPipe
				getInputFromSessionKey="ApplicationConfig"
                name="filter"
                styleSheetName="mappings/filterAppID.xslt"
                >
				<Param name="code" sessionKey="originalMessage" xpathExpression="personen/gemeenteVanInschrijving/code"/>
                <Forward name="success" path="XmlToJson"/>
                <Forward name="error" path="BadRequest"/>
            </XsltPipe>

            <Json2XmlValidatorPipe
                name="XmlToJson"
                root="root"
                schema="mappings/appId.xsd"
                outputFormat="JSON"
                compactJsonArrays="false"
                storeResultInSessionKey="storeInput"
                throwException="true">
                <Forward name="success" path="InsertPersoon" />
            </Json2XmlValidatorPipe>

            <SenderPipe name="InsertPersoon" getInputFromSessionKey="originalMessage">
                <FixedQuerySender
					name="insertPersonenSender"
					query="INSERT INTO personen VALUES(?,?,?,CURRENT_TIMESTAMP)"
					datasourceName="jdbc/haalcentraal-connector-postgresql">
					<Param name="burgerservicenummer" xpathExpression="personen/burgerservicenummer"/>
					<Param name="body" sessionKey="body"/>
					<Param name="appId" sessionKey="storeInput"/>
            	</FixedQuerySender>
                <Forward name="success" path="echoPipe" />
            </SenderPipe>

		<EchoPipe name="echoPipe">
			<Forward name="success" path="EXIT" />
		</EchoPipe>

		</Pipeline>
	</Adapter>
</Module>