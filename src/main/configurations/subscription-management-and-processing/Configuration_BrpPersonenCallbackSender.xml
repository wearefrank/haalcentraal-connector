<Module
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:noNamespaceSchemaLocation="../FrankConfig.xsd">
	<Adapter name="BrpPersonenCallbackSender"
		description="callback sender voor brp personen">

		<Receiver name="BrpPersonenCallbackSender">
			<JavaListener name="BrpPersonenCallbackSender" />
		</Receiver>

		<Receiver>
			<MessageStoreListener slotId="${instance.name}/taskStore" statusValueInProcess="I" />
		</Receiver>

		<Pipeline>
			<Exits>
				<Exit name="EXIT" state="SUCCESS" />
				<Exit name="BadRequest" state="ERROR" code="400" />
				<Exit name="NotAuthorized" state="ERROR" code="401" />
				<Exit name="Forbidden" state="ERROR" code="403" />
				<Exit name="NotFound" state="ERROR" code="404" />
				<Exit name="NotAcceptable" state="ERROR" code="406" />
				<Exit name="UnsupportedMediaType" state="ERROR" code="415" />
				<Exit name="TooManyRequest" state="ERROR" code="429" />
				<Exit name="ServerError" state="ERROR" code="500" />
				<Exit name="ServiceUnavailable" state="ERROR" code="503" />
				<Exit name="EXCEPTION" state="ERROR" />
			</Exits>

			<PutInSessionPipe name="SendCallbackToDatabase">
				<Param name="skipCallback" value="1" />
			</PutInSessionPipe>

			<JsonPipe name="ConvertMessageStoreToXml" storeResultInSessionKey="inputXml"/>

			<PutInSessionPipe name="StoreBsn" preserveInput="true">
				<Param name="bsn" xpathExpression="root/personen/burgerservicenummer"/>
			</PutInSessionPipe>

			<!-- Read application config file -->
			<LocalFileSystemPipe name="GetApplicationConfig" action="read"
				storeResultInSessionKey="applicationConfig">
				<Param name="filename" value="${applicationConfigPath}" />
			</LocalFileSystemPipe>

			<!-- Get application information from config -->
			<DataSonnetPipe name="TransformApplicationData"
				styleSheetName="jsonnet/FilterApplicationsById.jsonnet">
				<Param name="applicationConfig" sessionKey="applicationConfig" />
				<Param name="applicationId" xpathExpression="root/applicationId" sessionKey="inputXml"  />
			</DataSonnetPipe>

			<JsonPipe name="ConvertFilteredApplicationsToXml" storeResultInSessionKey="FilteredApplication" />

			<XsltPipe
				name="mappingJsonToStuf"
				styleSheetName="xsl/mappingJsonToStuf.xslt"
				getInputFromSessionKey="inputXml"
				storeResultInSessionKey="soapMessage">
				<Param name="varZenderApplicatie" sessionKey="FilteredApplication"
					xpathExpression="root/app/applicatie" />
				<Param name="varZenderOrganisatie" sessionKey="FilteredApplication"
					xpathExpression="root/app/organisatie"/>
				<Param name="varZenderGebruiker" sessionKey="FilteredApplication"
					xpathExpression="root/app/gebruiker" />
				<Param name="varReferentienummer" sessionKey="FilteredApplication"
					xpathExpression="root/app/referentienummer" />
				<Param name="varOntvangerApplicatie" value="NEDMAG_VnA" />
				<Param name="varOntvangerOrganisatie" value="NEDGR" />
				<!-- <Forward name="success" path="callback" /> -->
				<Forward name="exception" path="EXCEPTION" />
			</XsltPipe>

			<PutInSessionPipe name="ExtractUrl" getInputFromSessionKey="FilteredApplication">
				<Param name="url" xpathExpression="root/app/url" />
			</PutInSessionPipe>

			<XmlIfPipe name="CheckCallbackAction" >
				<Param name="action" sessionKey="skipCallback" />
				<Forward name="then" path="SendMessageToShadowdb" />
				<Forward name="else" path="callback" />
			</XmlIfPipe>

			<SenderPipe name="SendMessageToShadowdb">
				<FixedQuerySender name="storeCallbackMessage" query="INSERT INTO shadowmessages (message, app_id, bsn, is_frank, timestamp) VALUES (?, ?, ?, True, CURRENT_TIMESTAMP)">
					<Param name="message" sessionKey="soapMessage" type="BINARY" />
					<Param name="appId" xpathExpression="root/app/applicatie" sessionKey="FilteredApplication" />
					<Param name="bsn" sessionKey="bsn" />
				</FixedQuerySender>
				<Forward name="success" path="EXIT" />
				<Forward name="exception" path="EXCEPTION" />
			</SenderPipe>

			<SenderPipe
				name="callback"
				getInputFromSessionKey="soapMessage">
				<HttpSender
					methodType="POST"
					contentType="application/xml"
					keystore="${haalcentraal_cert_path}"
					keystorePassword="${haalcentraal_cert_pass}"
					keystoreAlias="haalcentraal"
					keystoreType="PKCS12">
				</HttpSender>
				<Param name="url" sessionKey="url" />
				<Forward name="success" path="echoPipe" />
				<Forward name="exception" path="EXCEPTION" />
			</SenderPipe>

			<EchoPipe name="echoPipe">
				<Forward name="success" path="EXIT" />
			</EchoPipe>
		</Pipeline>
	</Adapter>
</Module>