<Module
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="../FrankConfig.xsd">

    <Adapter name="BrpPersonenAfnemersIndicatieProcessor"
        description="Link an application to a person to receive a notification when personal data changes">

        <Receiver name="BrpPersonenAfnemersIndicatieProcessorReceiver" checkForDuplicates="true"
            maxRetries="0">
            <MessageStoreListener slotId="${instance.name}/afnemersIndicatieStore"
                statusValueInProcess="I" />
        </Receiver>

        <Pipeline>
            <Exits>
                <Exit name="EXIT" state="SUCCESS" />
                <Exit name="EXCEPTION" state="ERROR" />
            </Exits>

            <!-- Retrieve the application configuration from the local file system -->
            <SenderPipe
                name="LoadApplicationConfig"
                storeResultInSessionKey="ApplicationConfig">
                <IbisLocalSender
                    name="GetApplicationConfigFromLocalFileSystem"
                    javaListener="ProcessFileInputListener"
                    returnedSessionKeys="Error">
                    <Param name="FileName" value="${applicationConfigPath}" />
                </IbisLocalSender>
                <Forward name="success" path="ConvertInputToAppId" />
                <Forward name="exception" path="EXCEPTION" />
            </SenderPipe>

            <!-- Get the appid of the application related to the subscription action -->
            <XsltPipe name="ConvertInputToAppId"
                xpathExpression="/root/Applications[organisatie = $inputOrganisatie and applicatie = $inputApplicatie]/appId"
                storeResultInSessionKey="ApplicationId">
                <Param name="inputApplicatie" sessionKey="originalMessage"
                    xpathExpression="npsLk01/stuurgegevens/zender/applicatie" />
                <Param name="inputOrganisatie" sessionKey="originalMessage"
                    xpathExpression="npsLk01/stuurgegevens/zender/organisatie" />
            </XsltPipe>

            <!-- Retrieve the person by BSN -->
            <SenderPipe name="FetchPersonByBsn" storeResultInSessionKey="fetchedPersonEntries">
                <FixedQuerySender
                    name="FetchPersonSender"
                    queryType="SELECT"
                    query="SELECT * FROM persoonsgegevens WHERE bsn=?{burgerservicenummer}"
                    includeFieldDefinition="false">
                    <Param name="burgerservicenummer" sessionKey="originalMessage"
                        xpathExpression="npsLk01/object/inp.bsn" type="INTEGER" />
                </FixedQuerySender>
                <Forward name="success" path="CheckIfPersonExists" />
                <Forward name="exception" path="EXCEPTION" />
            </SenderPipe>

            <!-- Check if a person was found with the given BSN -->
            <XmlIfPipe name="CheckIfPersonExists" getInputFromSessionKey="fetchedPersonEntries"
                xpathExpression="/result/rowset/row">
                <Forward name="then" path="CheckVerwerkingssoort" />
                <Forward name="else" path="InsertNewPerson" />
            </XmlIfPipe>

            <!-- Add persoonsgegevens to db if none are found -->
            <SenderPipe name="InsertNewPerson">
                <IbisLocalSender name="InsertNewPersonSender" javaListener="BrpPersonenUpdateAndNotify">
                    <Param name="burgerservicenummer" sessionKey="originalMessage"
                        xpathExpression="npsLk01/object/inp.bsn" />
                </IbisLocalSender>
            </SenderPipe>

            <!-- Check if a subscriber needs to be either added or removed -->
            <XmlIfPipe name="CheckVerwerkingssoort" xpathExpression="$originalMessage = 'T'" getInputFromSessionKey="originalMessage">
                <Param name="originalMessage" sessionKey="originalMessage"
                    xpathExpression="npsLk01/object/@verwerkingssoort" />
                <Forward name="then" path="InsertNewSubscription" />
                <Forward name="else" path="EndSubscription" />
            </XmlIfPipe>

            <!-- Insert the new subscriber into the database -->
            <SenderPipe name="InsertNewSubscription" getInputFromSessionKey="originalMessage">
                <FixedQuerySender
                    name="InsertSubscriptionSender"
                    query="
                        INSERT INTO subscripties (bsn, app_id, begin_datum)
                        SELECT ?{burgerservicenummer}, ?{appId}, CURRENT_TIMESTAMP
                        WHERE NOT EXISTS (
                            SELECT 1
                            FROM subscripties
                            WHERE bsn = ?{burgerservicenummer}
                            AND app_id = ?{appId}
                            AND eind_datum IS NULL
                        );">
                    <Param name="burgerservicenummer" sessionKey="originalMessage"
                        xpathExpression="npsLk01/object/inp.bsn" />
                    <Param name="appId" sessionKey="ApplicationId" />
                </FixedQuerySender>
            </SenderPipe>
            <XmlIfPipe name="CheckNoSubscriptionAdded" xpathExpression="/result/rowsupdated = 0">
                <Forward name="then" path="noSubscriptionAdded" />
                <Forward name="else" path="EXIT" />
            </XmlIfPipe>

            <!-- Set the end date for the specified subscription to now -->
            <SenderPipe name="EndSubscription" getInputFromSessionKey="originalMessage">
                <FixedQuerySender
                    name="EndSubscriptionSender"
                    query="UPDATE subscripties SET eind_datum = CURRENT_TIMESTAMP WHERE bsn=?{burgerservicenummer} AND app_id=?{appId} AND eind_datum IS NULL">
                    <Param name="burgerservicenummer" sessionKey="originalMessage"
                        xpathExpression="npsLk01/object/inp.bsn" />
                    <Param name="appId" sessionKey="ApplicationId" />
                </FixedQuerySender>
            </SenderPipe>
            <XmlIfPipe name="CheckNoSubscriptionEnded" xpathExpression="/result/rowsupdated = 0">
                <Forward name="then" path="noSubscriptionEnded" />
                <Forward name="else" path="EXIT" />
            </XmlIfPipe>

            <!-- Exception handling -->
            <ExceptionPipe name="noPersonFoundWithGivenBsn" />
            <ExceptionPipe name="noSubscriptionAdded" />
            <ExceptionPipe name="noSubscriptionEnded" />
        </Pipeline>
    </Adapter>
</Module>