<Module 
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="../FrankConfig.xsd">
	<Adapter name="BrpPersonenNotificationReceiver"
		description="brp personen notification receiver">

		<Receiver name="BrpPersonenNotificationReceiver">
			<JavaListener name="BrpPersonenNotificationReceiver" />
		</Receiver>
        
        <Receiver name="RestEndpointRouter">
			<ApiListener name="RestEndpointRouter" uriPattern="${haalcentraal_connector.notification.rest.endpoint}" method="POST"/>
		</Receiver>

		<Pipeline>
			<Exits>
				<Exit name="EXIT" state="SUCCESS" code="202" />
				<Exit name="BadRequest" state="ERROR" code="400" />
			</Exits>

			<JsonValidatorPipe name="jsonValidator" schema="json/DataChangeNotificationSchema.json" onlyIfSessionKey="HttpMethod">
                <Forward name="success" path="JsonToXml" />
                <Forward name="exception" path="BadRequest" />
            </JsonValidatorPipe>

            <JsonPipe name="JsonToXml" prettyPrint="true">
                <Forward name="success" path="ExtractIncomingNotificationData"/>
            </JsonPipe>

            <!-- TODO: Process historic bsns correctly -->
            <PutInSessionPipe name="ExtractIncomingNotificationData">
                <Param name="bsn" xpathExpression="root/data/bsn" />
                <Param name="historicBsns" xpathExpression="root/data/historicBsns" />
                <Forward name="success" path="GetPersoon"/>
            </PutInSessionPipe>

            <!-- TODO: Check if person has historic bsns -->

            <!-- TODO: Update subscriptions to historic bsns to new bsn -->

            <SenderPipe name="GetPersoon">
                <FixedQuerySender
					name="getPersonenSender"
                    queryType="SELECT"
					query="SELECT * FROM persoonsgegevens WHERE bsn=?{burgerservicenummer} ORDER BY registratie_datum DESC LIMIT 1"
					includeFieldDefinition="false">
					<Param name="burgerservicenummer" sessionKey="bsn"/>
            	</FixedQuerySender> 
                <Forward name="success" path="PersonExists" />
                <Forward name="exception" path="BadRequest" />
            </SenderPipe>
            
            <XmlIfPipe
                name="PersonExists"
                xpathExpression="count(result/rowset/row) = 1"
            >
                <Forward name="then" path="InsertNotification"/>
                <Forward name="else" path="BadRequest"/>
                <Forward name="exception" path="BadRequest"/>
            </XmlIfPipe>

            <SenderPipe name="InsertNotification" getInputFromSessionKey="originalMessage">
				<MessageStoreSender
					slotId="${instance.name}/notificationStore"
				/>
                <Forward name="success" path="echoPipe" />
            </SenderPipe>

		<EchoPipe name="echoPipe">
			<Forward name="success" path="EXIT" />
		</EchoPipe>

		</Pipeline>
	</Adapter>
</Module>