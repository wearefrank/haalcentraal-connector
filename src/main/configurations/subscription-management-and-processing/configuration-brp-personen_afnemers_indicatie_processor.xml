<Module 
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="../FrankConfig.xsd">

	<Adapter name="brp personen afnemers indicatie processor"
		description="brp personen afnemers indicatie processor">

		<Receiver name="brp personen afnemers indicatie processor" checkForDuplicates="true" maxRetries="0" >
			<MessageStoreListener slotId="${instance.name}/afnemersIndicatieStore" statusValueInProcess="I"/>
		</Receiver>

		<Pipeline>
			<Exits>
				<Exit name="EXIT" state="SUCCESS" />
				<Exit name="EXCEPTION" state="ERROR" />
			</Exits>

            <!-- Retrieve the application configuration from the local file system -->
            <SenderPipe 
                name="GetApplicationConfigFromLocalFS"
                storeResultInSessionKey="ApplicationConfig"
                >
                <IbisLocalSender
                    name="CallImportFromLocalFS"
                    javaListener="ImportFromLocalFS"
                    returnedSessionKeys="Error">
                    <Param name="FileName" value="${FilePath_1}" />
                </IbisLocalSender>
                <Forward name="success" path="RetrieveSubscribersFromBSN"/>
                <Forward name="exception" path="EXCEPTION" />
            </SenderPipe>

            <!-- Retrieve the person by BSN -->
            <SenderPipe name="RetrieveSubscribersFromBSN" storeResultInSessionKey="databaseData">
                <FixedQuerySender
					name="getPersonenSender"
                    queryType="SELECT"
					query="SELECT * FROM persoonsgegevens WHERE bsn=?{burgerservicenummer}"
					includeFieldDefinition="false">
					<Param name="burgerservicenummer" sessionKey="originalMessage" xpathExpression="npsLk01/object/inp.bsn" type="INTEGER"/>
            	</FixedQuerySender> 
                <Forward name="success" path="PersonExistsCheck" />
                <Forward name="exception" path="EXCEPTION" />
            </SenderPipe>    

            <!-- Check if a person was found with the given BSN -->
            <!-- TODO: Add person if no entry was found -->
            <XmlIfPipe name="PersonExistsCheck" xpathExpression="/result/rowset/row">
                <Forward name="then" path="CheckVerwerkingssoort" />
                <Forward name="else" path="noPersonFoundWithGivenBsn" />
            </XmlIfPipe>      

            <!-- Add persoonsgegevens to db if none are found -->
            <!-- TODO: Send message to persoonbevragen -->
            <!-- <SenderPipe name="AddPersoonsgegevensRecordToDatabase">
                <IbisLocalSender name="RequestPersoonsgegevensByBsn">
                </IbisLocalSender>
            </SenderPipe> -->

            <!-- Check if a subscriber needs to be either added or removed -->
            <XmlIfPipe name="CheckVerwerkingssoort" xpathExpression="$originalMessage = 'T'">
                <Param name="originalMessage" sessionKey="originalMessage" xpathExpression="npsLk01/object/@verwerkingssoort"/>
                <Forward name="then" path="InsertNewSubscriber" />
                <Forward name="else" path="DeleteSubscriber" />
            </XmlIfPipe>

            <!-- Insert the new subscriber into the database -->
            <!-- TODO: Map subscriber from messagestore to actual app_id -->
            <SenderPipe name="InsertNewSubscriber" getInputFromSessionKey="originalMessage">
                <FixedQuerySender
					name="insertPersonenSender"
					query="
                        INSERT INTO subscripties (bsn, app_id, begin_datum)
                        SELECT ?{burgerservicenummer}, ?{appId}, CURRENT_TIMESTAMP
                        WHERE NOT EXISTS (
                            SELECT 1
                            FROM subscripties
                            WHERE bsn = ?{burgerservicenummer}
                            AND app_id = ?{appId}
                            AND eind_datum IS NULL
                        );">
					<Param name="burgerservicenummer" sessionKey="originalMessage" xpathExpression="npsLk01/object/inp.bsn"/>
					<Param name="appId" sessionKey="originalMessage" xpathExpression="npsLk01/stuurgegevens/zender/organisatie"/>
            	</FixedQuerySender>
            </SenderPipe>
            <XmlIfPipe name="NoSubscriptionAdded" xpathExpression="/result/rowsupdated = 0">
                <Forward name="then" path="noSubscriptionAdded" />
                <Forward name="else" path="EXIT" />
            </XmlIfPipe>

            <!-- Set the end date for the specified subscription to now -->
            <SenderPipe name="DeleteSubscriber" getInputFromSessionKey="originalMessage">
                <FixedQuerySender
					name="insertPersonenSender"
					query="UPDATE subscripties SET eind_datum = CURRENT_TIMESTAMP WHERE bsn=?{burgerservicenummer} AND app_id=?{appId} AND eind_datum IS NULL">
					<Param name="burgerservicenummer" sessionKey="originalMessage" xpathExpression="npsLk01/object/inp.bsn"/>
					<Param name="appId" sessionKey="originalMessage" xpathExpression="npsLk01/stuurgegevens/zender/organisatie"/>
            	</FixedQuerySender>
            </SenderPipe>
            <XmlIfPipe name="NoSubscriptionEnded" xpathExpression="/result/rowsupdated = 0">
                <Forward name="then" path="noSubscriptionDeleted" />
                <Forward name="else" path="EXIT" />
            </XmlIfPipe>

            <!-- Exception handling -->
            <XmlIfPipe name="noChangeException" xpathExpression="$originalMessage/npsLk01/object/@verwerkingssoort = 'T'">
                <Param name="originalMessage" sessionKey="originalMessage" type="DOMDOC"/>
                <Forward name="then" path="noSubscriptionAdded" />
                <Forward name="else" path="noSubscriptionDeleted" />
            </XmlIfPipe>
            
            <ExceptionPipe name="noPersonFoundWithGivenBsn"/>
            <ExceptionPipe name="noSubscriptionAdded"/>
            <ExceptionPipe name="noSubscriptionDeleted"/>
		</Pipeline>
	</Adapter>
</Module>